# FILE: reporting_utils.py (Final, Pillow-based Version)

import streamlit as st
import io
import json
from fpdf import FPDF
from pptx import Presentation
from pptx.util import Inches, Pt
import plotly.graph_objects as go
import matplotlib.pyplot as plt
import textwrap
from PIL import Image

# ==============================================================================
# IMAGE GENERATION ENGINE (NEW & ENHANCED)
# ==============================================================================
def create_kpi_image(kpis, title="Key Performance Indicators & Summary"):
    """Creates a PNG image from a dictionary of KPIs using Matplotlib."""
    formatted_kpis = {}
    for key, value in kpis.items():
        if isinstance(value, dict):
            json_str = json.dumps(value, indent=2)
            formatted_kpis[key] = f"\n{json_str}"
        else:
            formatted_kpis[key] = value
            
    lines = [f"{title}\n" + "="*len(title)]
    for key, value in formatted_kpis.items():
        key_lines = textwrap.wrap(f"{key}:", width=35)
        value_lines = textwrap.wrap(str(value), width=70)
        lines.append(key_lines[0])
        for line in key_lines[1:]: lines.append(f"  {line}")
        for line in value_lines: lines.append(f"    {line}")
        lines.append("")
        
    text_to_render = "\n".join(lines)
    num_lines = text_to_render.count('\n')
    fig_height = max(4, num_lines * 0.25)
    fig, ax = plt.subplots(figsize=(8.5, fig_height))
    ax.text(0.01, 0.99, text_to_render, transform=ax.transAxes, fontsize=12, family='monospace', va='top', ha='left')
    ax.axis('off')
    buf = io.BytesIO()
    fig.savefig(buf, format='png', bbox_inches='tight', dpi=200)
    plt.close(fig)
    buf.seek(0)
    return buf

def create_title_image(title, subtitle):
    """Creates a PNG image for a title slide."""
    fig, ax = plt.subplots(figsize=(8.5, 11))
    ax.text(0.5, 0.6, title, transform=ax.transAxes, fontsize=24, weight='bold', ha='center', va='center')
    ax.text(0.5, 0.5, subtitle, transform=ax.transAxes, fontsize=16, style='italic', ha='center', va='center')
    ax.text(0.5, 0.4, "Generated by V&V Sentinel Toolkit", transform=ax.transAxes, fontsize=12, ha='center', va='center')
    ax.axis('off')
    buf = io.BytesIO()
    fig.savefig(buf, format='png', bbox_inches='tight', dpi=200)
    plt.close(fig)
    buf.seek(0)
    return buf

def create_figure_title_image(fig_title):
    """Creates a PNG image for a figure title."""
    fig, ax = plt.subplots(figsize=(8.5, 1.0))
    ax.text(0.5, 0.5, f"- {fig_title}", transform=ax.transAxes, fontsize=18, style='italic', ha='center', va='center')
    ax.axis('off')
    buf = io.BytesIO()
    fig.savefig(buf, format='png', bbox_inches='tight', dpi=200)
    plt.close(fig)
    buf.seek(0)
    return buf

# ==============================================================================
# PDF REPORTING ENGINE (Final - Pillow Based)
# ==============================================================================
def generate_pdf_report(title, kpis, figures):
    """Generates a multi-page PDF report by assembling pre-rendered images using Pillow."""
    image_buffers = []
    
    # 1. Create title page image
    image_buffers.append(create_title_image(title, "Analysis Report"))

    # 2. Create KPI page image
    if kpis:
        image_buffers.append(create_kpi_image(kpis))

    # 3. Create images for each figure
    if figures:
        for fig_title, fig in figures.items():
            try:
                # Add a title card for each figure
                image_buffers.append(create_figure_title_image(fig_title))
                
                img_buf = io.BytesIO()
                if isinstance(fig, go.Figure): fig.write_image(img_buf, format='png', scale=2, width=800, height=500)
                elif isinstance(fig, plt.Figure): fig.savefig(img_buf, format='png', bbox_inches='tight', dpi=200)
                else: img_buf = fig
                img_buf.seek(0)
                image_buffers.append(img_buf)
            except Exception:
                # If image rendering fails, create an error image instead
                error_image = create_figure_title_image(f"Error: Could not render '{fig_title}'. Please run locally.")
                image_buffers.append(error_image)

    if not image_buffers:
        return b"" # Return empty bytes if there's nothing to report

    # 4. Use Pillow to assemble the PDF
    pil_images = [Image.open(buf).convert("RGB") for buf in image_buffers]
    
    pdf_buffer = io.BytesIO()
    pil_images[0].save(
        pdf_buffer,
        "PDF",
        resolution=100.0,
        save_all=True,
        append_images=pil_images[1:]
    )
    return pdf_buffer.getvalue()

# ==============================================================================
# POWERPOINT REPORTING ENGINE (Final)
# ==============================================================================
def generate_pptx_report(title, kpis, figures):
    """Generates a multi-slide PowerPoint report with robust error handling."""
    prs = Presentation()
    slide = prs.slides.add_slide(prs.slide_layouts[0])
    slide.shapes.title.text = title; slide.placeholders[1].text = "Generated by V&V Sentinel Toolkit"

    if kpis:
        slide = prs.slides.add_slide(prs.slide_layouts[5])
        slide.shapes.add_textbox(Inches(0.5), Inches(0.2), Inches(9), Inches(0.5)).text_frame.text = "Key Performance Indicators & Summary"
        kpi_image_buf = create_kpi_image(kpis)
        slide.shapes.add_picture(kpi_image_buf, Inches(0.5), Inches(1.0), width=Inches(9.0))

    if figures:
        for fig_title, fig in figures.items():
            slide = prs.slides.add_slide(prs.slide_layouts[5])
            title_box = slide.shapes.add_textbox(Inches(0.5), Inches(0.2), Inches(9), Inches(0.5))
            title_box.text_frame.text = fig_title
            try:
                img_buf = io.BytesIO()
                if isinstance(fig, go.Figure): fig.write_image(img_buf, format='png', scale=2, width=800, height=500)
                elif isinstance(fig, plt.Figure): fig.savefig(img_buf, format='png', bbox_inches='tight', dpi=200)
                else: img_buf = fig
                img_buf.seek(0)
                slide.shapes.add_picture(img_buf, Inches(0.5), Inches(1.0), width=Inches(9.0))
            except Exception as e:
                err_box = slide.shapes.add_textbox(Inches(1), Inches(2), Inches(8), Inches(4))
                tf = err_box.text_frame; tf.clear()
                p1 = tf.add_paragraph(); p1.text = f"Error Rendering: '{fig_title}'"; p1.font.bold = True; p1.font.size = Pt(24)
                p2 = tf.add_paragraph(); p2.text = "\nRoot Cause:"; p2.font.bold = True; p2.font.size = Pt(18)
                p3 = tf.add_paragraph(); p3.text = "The 'Kaleido' image rendering engine is likely incompatible with the cloud deployment environment."; p3.font.size = Pt(14)
    
    pptx_buffer = io.BytesIO()
    prs.save(pptx_buffer)
    return pptx_buffer.getvalue()

# ==============================================================================
# MASTER UI RENDERING FUNCTION (Final)
# ==============================================================================
def render_reporting_section(report_title, kpis, figures):
    """Renders the entire reporting UI section with robust error handling for cloud environments."""
    st.divider()
    st.subheader("Reporting")
    with st.container(border=True):
        st.markdown("**Generate a formal report of this analysis.**")
        pdf_col, pptx_col = st.columns(2)
        clean_title = report_title.replace(" ", "_").replace(":", "").replace("/", "_")
        
        unique_key_base = f"{clean_title}_{hash(str(kpis))}_{hash(str(figures))}"

        with pdf_col:
            try:
                pdf_bytes = generate_pdf_report(report_title, kpis, figures)
                st.download_button("üìÑ Download PDF Report", pdf_bytes, f"{clean_title}.pdf", "application/pdf", use_container_width=True, key=f"pdf_{unique_key_base}")
            except Exception as e: st.error(f"PDF generation failed: {e}")
        
        with pptx_col:
            try:
                pptx_bytes = generate_pptx_report(report_title, kpis, figures)
                st.download_button("üìä Download PowerPoint Report", pptx_bytes, f"{clean_title}.pptx", "application/vnd.openxmlformats-officedocument.presentationml.presentation", use_container_width=True, key=f"pptx_{unique_key_base}")
            except Exception as e:
                st.download_button("üìä Download PowerPoint Report", b"", disabled=True, use_container_width=True, key=f"pptx_disabled_{unique_key_base}")
                if ' Kaleido ' in str(e) or 'unsupported operating system' in str(e).lower() or 'xvfb' in str(e).lower():
                    st.warning("Chart rendering for PowerPoint is disabled in this cloud environment. Please run the app locally for full reports.", icon="‚öôÔ∏è")
                else:
                    st.error(f"PPTX Error: {e}")
